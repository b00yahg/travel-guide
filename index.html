<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D&D Travel Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #2a3f2b;
            --primary-medium: #3c5a3e;
            --primary-light: #5c8a5f;
            --bg-main: #e6d8b5;
            --bg-container: #f0e6c8;
            --bg-content: #f9f3e3;
            --accent-danger: #8a5c5c;
            --accent-highlight: #ffd700;
            --disabled-text: #8a5c5c;
            --border-color: #3c5a3e;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--primary-dark);
            margin: 0;
            padding: 20px;
        }

        .travel-planner {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg-content);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .planner-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .planner-header h1 {
            font-family: 'Uncial Antiqua', cursive;
            color: var(--primary-dark);
            font-size: 2.5em;
            margin: 0;
            padding: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .action-button {
            background: var(--primary-light);
            color: var(--bg-content);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Uncial Antiqua', cursive;
            font-size: 0.9em;
        }

        .action-button:hover {
            background: var(--primary-medium);
        }

        .journey-basics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .input-group input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-container);
        }

        .party-speed {
            background: var(--bg-container);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .speed-calculations {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .speed-box {
            background: var(--bg-content);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .speed-box h3 {
            margin: 0 0 10px 0;
            color: var(--primary-dark);
            font-family: 'Uncial Antiqua', cursive;
        }

        .stage {
            background: var(--bg-container);
            border: 2px solid var(--primary-medium);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .stage-header {
            background: rgba(92, 138, 95, 0.2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage-header h2 {
            font-family: 'Uncial Antiqua', cursive;
            margin: 0;
        }

        .stage-content {
            padding: 20px;
        }

        .stage-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .travel-times {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .time-box {
            background: var(--bg-content);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .time-box.disabled {
            color: var(--disabled-text);
            background: rgba(138, 92, 92, 0.1);
        }

        .terrain-info {
            background: var(--bg-content);
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .notes-challenges {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .notes-section textarea,
        .challenges-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-content);
            resize: vertical;
        }

        .weather-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .challenges-list {
            margin-top: 10px;
        }

        .challenge-item {
            background: var(--bg-content);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            padding: 10px;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .delete-button {
            background: var(--accent-danger);
            color: var(--bg-content);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-content);
        }

        .elapsed-time {
            text-align: right;
            margin-top: 20px;
        }

        .add-stage-button {
            width: 100%;
            padding: 15px;
            background: var(--primary-light);
            color: var(--bg-content);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Uncial Antiqua', cursive;
            margin-top: 20px;
        }

        .add-stage-button:hover {
            background: var(--primary-medium);
        }
    </style>
</head>
<body>
    <div class="travel-planner">
        <div class="planner-header">
            <h1>Travel Planner</h1>
        </div>

        <div class="action-buttons">
            <button class="action-button" onclick="saveJourney()">Save Journey</button>
            <button class="action-button" onclick="loadJourney()">Load Journey</button>
            <button class="action-button" onclick="exportToMarkdown()">Export to Markdown</button>
        </div>

        <div class="journey-basics">
            <div class="input-group">
                <label for="origin">Origin:</label>
                <input type="text" id="origin">
            </div>
            <div class="input-group">
                <label for="destination">Destination:</label>
                <input type="text" id="destination">
            </div>
        </div>

        <div class="party-speed">
            <div class="input-group">
                <label for="party-speed">Slowest Party Member's (or Vehicle's) Speed (feet):</label>
                <input type="number" id="party-speed" onchange="updateBaseSpeeds()" min="0" step="5">
            </div>
            <div class="speed-calculations">
                <div class="speed-box">
                    <h3>Normal Pace</h3>
                    <div id="normal-base">-- miles/day</div>
                </div>
                <div class="speed-box">
                    <h3>Fast Pace</h3>
                    <div id="fast-base">-- miles/day</div>
                </div>
                <div class="speed-box">
                    <h3>Slow Pace</h3>
                    <div id="slow-base">-- miles/day</div>
                </div>
            </div>
        </div>

        <div id="stages-container">
            <!-- Stages will be dynamically added here -->
        </div>

        <button class="add-stage-button" onclick="addStage()">Add New Stage</button>
    </div>

    <script>
        // Stage template function
        function createStageTemplate(stageNum) {
            return `
                <div class="stage" id="stage-${stageNum}">
                    <div class="stage-header">
                        <h2>Stage ${stageNum}</h2>
                        <button class="delete-button" onclick="deleteStage(${stageNum})">Delete Stage</button>
                    </div>
                    <div class="stage-content">
                        <div class="stage-grid">
                            <div class="input-group">
                                <label for="start-${stageNum}">Start:</label>
                                <input type="text" id="start-${stageNum}">
                            </div>
                            <div class="input-group">
                                <label for="end-${stageNum}">End:</label>
                                <input type="text" id="end-${stageNum}">
                            </div>
                            <div class="input-group">
                                <label for="distance-${stageNum}">Distance (miles):</label>
                                <input type="number" id="distance-${stageNum}" onchange="updateTravelTimes(${stageNum})" min="0">
                            </div>
                            <div class="input-group">
                                <label for="terrain-${stageNum}">Terrain:</label>
                                <select id="terrain-${stageNum}" onchange="updateTerrainInfo(${stageNum})">
                                    <option value="arctic">Arctic</option>
                                    <option value="coastal">Coastal</option>
                                    <option value="desert">Desert</option>
                                    <option value="forest">Forest</option>
                                    <option value="grassland">Grassland</option>
                                    <option value="hill">Hill</option>
                                    <option value="mountain">Mountain</option>
                                    <option value="swamp">Swamp</option>
                                    <option value="underdark">Underdark</option>
                                    <option value="urban">Urban</option>
                                    <option value="waterborne">Waterborne</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="rations-${stageNum}">Available Rations:</label>
                                <input type="number" id="rations-${stageNum}" min="0">
                            </div>
                            <div class="weather-controls">
                                <div class="input-group">
                                    <label>Temperature:</label>
                                    <select id="temp-${stageNum}">
                                        <option value="normal">Normal for season</option>
                                        <option value="cold">Colder (1d4 × 10°F)</option>
                                        <option value="hot">Hotter (1d4 × 10°F)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Wind:</label>
                                    <select id="wind-${stageNum}">
                                        <option value="none">None</option>
                                        <option value="light">Light</option>
                                        <option value="strong">Strong</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Precipitation:</label>
                                    <select id="precip-${stageNum}">
                                        <option value="none">None</option>
                                        <option value="light">Light</option>
                                        <option value="heavy">Heavy</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="travel-times">
                            <div class="time-box" id="slow-${stageNum}">
                                <h3>Slow</h3>
                                <div class="time">-- days/hrs</div>
                            </div>
                            <div class="time-box" id="normal-${stageNum}">
                                <h3>Normal</h3>
                                <div class="time">-- days/hrs</div>
                            </div>
                            <div class="time-box" id="fast-${stageNum}">
                                <h3>Fast</h3>
                                <div class="time">-- days/hrs</div>
                            </div>
                        </div>
                        
                        <div class="travel-times terrain-dcs">
                            <div class="time-box">
                                <h3>Foraging DC</h3>
                                <div id="foraging-${stageNum}">--</div>
                            </div>
                            <div class="time-box">
                                <h3>Navigation DC</h3>
                                <div id="navigation-${stageNum}">--</div>
                            </div>
                            <div class="time-box">
                                <h3>Search DC</h3>
                                <div id="search-${stageNum}">--</div>
                            </div>
                        </div>

                        <div class="notes-challenges">
                            <div class="notes-section">
                                <label for="notes-${stageNum}">Narrative Notes:</label>
                                <textarea id="notes-${stageNum}"></textarea>
                            </div>
                            <div class="challenges-section">
                                <label>Challenges:</label>
                                <select id="challenge-type-${stageNum}" onchange="addChallenge(${stageNum})">
                                    <option value="">Select a challenge...</option>
                                    <option value="damage">Damage</option>
                                    <option value="exhaustion">Exhaustion</option>
                                    <option value="condition">Another Condition</option>
                                    <option value="ambush">Ambush</option>
                                    <option value="attack">Attack from Above</option>
                                    <option value="distant">Distant Sighting</option>
                                    <option value="found">Found by Chance</option>
                                    <option value="pursuit">Pursuit</option>
                                </select>
                                <div id="challenges-list-${stageNum}" class="challenges-list"></div>
                            </div>
                        </div>

                        <div class="elapsed-time">
                            <label>Elapsed Time:</label>
                            <input type="text" id="elapsed-${stageNum}" readonly>
                        </div>
                    </div>
                </div>
            `;
        }

        // Terrain data
        const terrainData = {
            arctic: { 
                maxPace: "fast", 
                note: "Appropriate equipment (such as skis) needed for Fast pace",
                foragingDC: 20,
                navigationDC: 10,
                searchDC: 10,
                encounterDistance: "6d6 × 10 feet"
            },
            coastal: { 
                maxPace: "normal",
                foragingDC: 10,
                navigationDC: 5,
                searchDC: 15,
                encounterDistance: "2d10 × 10 feet"
            },
            desert: { 
                maxPace: "normal",
                foragingDC: 20,
                navigationDC: 10,
                searchDC: 10,
                encounterDistance: "6d6 × 10 feet"
            },
            forest: { 
                maxPace: "normal",
                foragingDC: 10,
                navigationDC: 15,
                searchDC: 15,
                encounterDistance: "2d8 × 10 feet"
            },
            grassland: { 
                maxPace: "fast",
                foragingDC: 15,
                navigationDC: 5,
                searchDC: 15,
                encounterDistance: "6d6 × 10 feet"
            },
            hill: { 
                maxPace: "normal",
                foragingDC: 15,
                navigationDC: 10,
                searchDC: 15,
                encounterDistance: "2d10 × 10 feet"
            },
            mountain: { 
                maxPace: "slow",
                foragingDC: 20,
                navigationDC: 15,
                searchDC: 20,
                encounterDistance: "4d10 × 10 feet"
            },
            swamp: { 
                maxPace: "slow",
                foragingDC: 10,
                navigationDC: 15,
                searchDC: 20,
                encounterDistance: "2d8 × 10 feet"
            },
            underdark: { 
                maxPace: "normal",
                foragingDC: 20,
                navigationDC: 10,
                searchDC: 20,
                encounterDistance: "2d6 × 10 feet"
            },
            urban: { 
                maxPace: "normal",
                foragingDC: 20,
                navigationDC: 15,
                searchDC: 15,
                encounterDistance: "2d6 × 10 feet"
            },
            waterborne: { 
                maxPace: "special",
                note: "Travel pace depends on the vehicle",
                foragingDC: 15,
                navigationDC: 10,
                searchDC: 15,
                encounterDistance: "6d6 × 10 feet"
            }
        };

        let stageCount = 0;
        let baseSpeeds = {
            normal: 0,
            fast: 0,
            slow: 0
        };

        // Calculate base travel speeds based on party speed
        function updateBaseSpeeds() {
            const partySpeed = parseFloat(document.getElementById('party-speed').value) || 0;
            const milesPerHour = partySpeed / 10;
            
            // Calculate base speeds
            baseSpeeds.normal = milesPerHour * 8;
            baseSpeeds.fast = baseSpeeds.normal * 1.333;
            baseSpeeds.slow = baseSpeeds.normal * 0.667;

            // Update display
            document.getElementById('normal-base').textContent = `${baseSpeeds.normal.toFixed(1)} miles/day`;
            document.getElementById('fast-base').textContent = `${baseSpeeds.fast.toFixed(1)} miles/day`;
            document.getElementById('slow-base').textContent = `${baseSpeeds.slow.toFixed(1)} miles/day`;

            // Update all existing stages
            for (let i = 1; i <= stageCount; i++) {
                updateTravelTimes(i);
            }
        }

        function addStage() {
            stageCount++;
            const stagesContainer = document.getElementById('stages-container');
            stagesContainer.insertAdjacentHTML('beforeend', createStageTemplate(stageCount));
            updateTerrainInfo(stageCount);
        }

        function deleteStage(stageNum) {
            const stage = document.getElementById(`stage-${stageNum}`);
            stage.remove();
        }

        function updateTerrainInfo(stageNum) {
            const terrainSelect = document.getElementById(`terrain-${stageNum}`);
            const terrain = terrainSelect.value;
            const terrainInfo = terrainData[terrain];
            
            // Update pace options
            updatePaceOptions(stageNum, terrainInfo.maxPace);
            
            // Update DC display
            document.getElementById(`foraging-${stageNum}`).textContent = terrainInfo.foragingDC;
            document.getElementById(`navigation-${stageNum}`).textContent = terrainInfo.navigationDC;
            document.getElementById(`search-${stageNum}`).textContent = terrainInfo.searchDC;

            updateTravelTimes(stageNum);
        }

        function updatePaceOptions(stageNum, maxPace) {
            const paces = ['slow', 'normal', 'fast'];
            const maxPaceIndex = paces.indexOf(maxPace);
            
            paces.forEach((pace, index) => {
                const timeBox = document.getElementById(`${pace}-${stageNum}`);
                if (maxPace === 'special') {
                    timeBox.classList.add('disabled');
                } else if (index <= maxPaceIndex) {
                    timeBox.classList.remove('disabled');
                } else {
                    timeBox.classList.add('disabled');
                }
            });
        }

        function updateTravelTimes(stageNum) {
            const distance = parseFloat(document.getElementById(`distance-${stageNum}`).value) || 0;
            const terrain = document.getElementById(`terrain-${stageNum}`).value;
            
            if (terrainData[terrain].maxPace !== 'special') {
                Object.entries(baseSpeeds).forEach(([pace, speed]) => {
                    if (speed > 0) {
                        const timeElement = document.querySelector(`#${pace}-${stageNum} .time`);
                        const days = distance / speed;
                        const fullDays = Math.floor(days);
                        const hours = Math.round((days - fullDays) * 8);
                        timeElement.textContent = hours > 0 ? 
                            `${fullDays} days, ${hours} hrs` : 
                            `${fullDays} days`;
                    }
                });
            }
        }

        function addChallenge(stageNum) {
            const select = document.getElementById(`challenge-type-${stageNum}`);
            const challengeType = select.value;
            if (!challengeType) return;

            const challengesList = document.getElementById(`challenges-list-${stageNum}`);
            const challengeDiv = document.createElement('div');
            challengeDiv.className = 'challenge-item';
            
            let challengeContent = `
                <div class="challenge-header">
                    ${challengeType.charAt(0).toUpperCase() + challengeType.slice(1)}
                    <button class="delete-button" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
                <textarea placeholder="Add notes about this challenge..."></textarea>
            `;
            
            challengeDiv.innerHTML = challengeContent;
            challengesList.appendChild(challengeDiv);
            select.value = '';
        }

        // Initialize first stage
        addStage();
        function saveJourney() {
            const journeyData = {
                origin: document.getElementById('origin').value,
                destination: document.getElementById('destination').value,
                partySpeed: document.getElementById('party-speed').value,
                baseSpeeds: baseSpeeds,
                stages: []
            };

            // Collect data from each stage
            for (let i = 1; i <= stageCount; i++) {
                const stage = document.getElementById(`stage-${i}`);
                if (stage) {
                    const stageData = {
                        start: document.getElementById(`start-${i}`).value,
                        end: document.getElementById(`end-${i}`).value,
                        distance: document.getElementById(`distance-${i}`).value,
                        terrain: document.getElementById(`terrain-${i}`).value,
                        rations: document.getElementById(`rations-${i}`).value,
                        weather: {
                            temperature: document.getElementById(`temp-${i}`).value,
                            wind: document.getElementById(`wind-${i}`).value,
                            precipitation: document.getElementById(`precip-${i}`).value
                        },
                        notes: document.getElementById(`notes-${i}`).value,
                        challenges: Array.from(document.getElementById(`challenges-list-${i}`).children).map(challenge => ({
                            type: challenge.querySelector('.challenge-header').textContent.trim().split('×')[0].trim(),
                            notes: challenge.querySelector('textarea').value
                        })),
                        elapsedTime: document.getElementById(`elapsed-${i}`).value
                    };
                    journeyData.stages.push(stageData);
                }
            }

            // Create and download JSON file
            const blob = new Blob([JSON.stringify(journeyData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'journey-plan.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadJourney() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(e) {
                try {
                    const file = e.target.files[0];
                    const text = await file.text();
                    const journeyData = JSON.parse(text);
                    
                    // Clear existing stages
                    document.getElementById('stages-container').innerHTML = '';
                    stageCount = 0;
                    
                    // Load basic info
                    document.getElementById('origin').value = journeyData.origin;
                    document.getElementById('destination').value = journeyData.destination;
                    document.getElementById('party-speed').value = journeyData.partySpeed;
                    baseSpeeds = journeyData.baseSpeeds;
                    updateBaseSpeeds();
                    
                    // Load stages
                    journeyData.stages.forEach((stageData, index) => {
                        addStage();
                        const i = index + 1;
                        
                        document.getElementById(`start-${i}`).value = stageData.start;
                        document.getElementById(`end-${i}`).value = stageData.end;
                        document.getElementById(`distance-${i}`).value = stageData.distance;
                        document.getElementById(`terrain-${i}`).value = stageData.terrain;
                        document.getElementById(`rations-${i}`).value = stageData.rations;
                        
                        // Weather
                        document.getElementById(`temp-${i}`).value = stageData.weather.temperature;
                        document.getElementById(`wind-${i}`).value = stageData.weather.wind;
                        document.getElementById(`precip-${i}`).value = stageData.weather.precipitation;
                        
                        // Notes
                        document.getElementById(`notes-${i}`).value = stageData.notes;
                        
                        // Challenges
                        stageData.challenges.forEach(challenge => {
                            const select = document.getElementById(`challenge-type-${i}`);
                            select.value = challenge.type.toLowerCase();
                            addChallenge(i);
                            const lastChallenge = document.getElementById(`challenges-list-${i}`).lastElementChild;
                            lastChallenge.querySelector('textarea').value = challenge.notes;
                        });
                        
                        document.getElementById(`elapsed-${i}`).value = stageData.elapsedTime;
                        updateTerrainInfo(i);
                    });
                } catch (error) {
                    alert('Error loading journey data: ' + error.message);
                }
            };
            
            input.click();
        }

        function exportToMarkdown() {
            let mdContent = `# Journey Plan: [[${document.getElementById('origin').value}]] to [[${document.getElementById('destination').value}]]\n`;
            mdContent += `*Created: ${new Date().toISOString().split('T')[0]}*\n\n`;
            
            // Journey Overview
            mdContent += `> [!info] Journey Overview\n`;
            mdContent += `> **Party Speed:** ${document.getElementById('party-speed').value} feet\n`;
            mdContent += `> **Total Distance:** ${calculateTotalDistance()} miles\n`;
            mdContent += `> **Estimated Duration:** ${calculateTotalDuration()}\n`;
            mdContent += `> **Required Rations:** ${calculateTotalRations()}\n\n`;
            
            // Base Travel Speeds
            mdContent += `## Base Travel Speeds\n`;
            mdContent += `| Pace | Speed (miles/day) |\n`;
            mdContent += `|------|------------------|\n`;
            mdContent += `| Fast | ${baseSpeeds.fast.toFixed(1)} |\n`;
            mdContent += `| Normal | ${baseSpeeds.normal.toFixed(1)} |\n`;
            mdContent += `| Slow | ${baseSpeeds.slow.toFixed(1)} |\n\n`;
            
            // Stages
            for (let i = 1; i <= stageCount; i++) {
                const stage = document.getElementById(`stage-${i}`);
                if (stage) {
                    const terrain = terrainData[document.getElementById(`terrain-${i}`).value];
                    
                    mdContent += `## Stage ${i}: [[${document.getElementById(`start-${i}`).value}]] to [[${document.getElementById(`end-${i}`).value}]]\n\n`;
                    
                    // Travel Time Table
                    mdContent += `### Travel Time\n`;
                    mdContent += `| Fast | Normal | Slow |\n`;
                    mdContent += `|:---:|:---:|:---:|\n`;
                    if (terrain.maxPace !== 'special') {
                        const fastTime = document.querySelector(`#fast-${i} .time`).textContent;
                        const normalTime = document.querySelector(`#normal-${i} .time`).textContent;
                        const slowTime = document.querySelector(`#slow-${i} .time`).textContent;
                        mdContent += `| **${fastTime}** | **${normalTime}** | **${slowTime}** |\n\n`;
                    } else {
                        mdContent += `| *Special: Travel pace depends on vehicle* | | |\n\n`;
                    }
                    
                    // Route Information
                    mdContent += `### Route Information\n`;
                    mdContent += `> [!note] Route Details\n`;
                    mdContent += `> **Distance:** ${document.getElementById(`distance-${i}`).value} miles\n`;
                    mdContent += `> **Available Rations:** ${document.getElementById(`rations-${i}`).value}\n\n`;
                    
                    // Terrain & Navigation
                    mdContent += `### Terrain & Navigation\n`;
                    mdContent += `> [!example] ${document.getElementById(`terrain-${i}`).value} Terrain\n`;
                    mdContent += `> **Movement Considerations:**\n`;
                    if (terrain.note) mdContent += `> - ${terrain.note}\n`;
                    mdContent += `> \n`;
                    mdContent += `> **Difficulty Checks**\n`;
                    mdContent += `> - Foraging: DC ${terrain.foragingDC}\n`;
                    mdContent += `> - Navigation: DC ${terrain.navigationDC}\n`;
                    mdContent += `> - Search: DC ${terrain.searchDC}\n`;
                    mdContent += `> \n`;
                    mdContent += `> **Encounter Distance:** ${terrain.encounterDistance}\n\n`;
                    
                    // Weather Conditions
                    mdContent += `### Weather Conditions\n`;
                    mdContent += `| Condition | Status |\n`;
                    mdContent += `|-----------|--------|\n`;
                    mdContent += `| Temperature | ${document.getElementById(`temp-${i}`).value} |\n`;
                    mdContent += `| Wind | ${document.getElementById(`wind-${i}`).value} |\n`;
                    mdContent += `| Precipitation | ${document.getElementById(`precip-${i}`).value} |\n\n`;
                    
                    // Challenges
                    const challengesList = document.getElementById(`challenges-list-${i}`);
                    if (challengesList.children.length > 0) {
                        mdContent += `### Challenges\n`;
                        Array.from(challengesList.children).forEach((challenge) => {
                            const type = challenge.querySelector('.challenge-header').textContent.trim().split('×')[0].trim();
                            const notes = challenge.querySelector('textarea').value;
                            mdContent += `- [ ] ${type}: ${notes}\n`;
                        });
                        mdContent += '\n';
                    }
                    
                    // Narrative Notes
                    const notes = document.getElementById(`notes-${i}`).value;
                    if (notes) {
                        mdContent += `### Narrative Notes\n${notes}\n\n`;
                    }
                    
                    mdContent += `---\n\n`;
                }
            }
            
            // Create and download MD file
            const blob = new Blob([mdContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'journey-plan.md';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Helper functions for calculations
        function calculateTotalDistance() {
            let total = 0;
            for (let i = 1; i <= stageCount; i++) {
                const distance = document.getElementById(`distance-${i}`);
                if (distance && distance.value) {
                    total += parseFloat(distance.value);
                }
            }
            return total.toFixed(1);
        }
        
        function calculateTotalDuration() {
            let total = 0;
            for (let i = 1; i <= stageCount; i++) {
                const normalTime = document.querySelector(`#normal-${i} .time`);
                if (normalTime) {
                    const timeStr = normalTime.textContent;
                    const [days, hours] = timeStr.split(' ')[0].split('/');
                    total += parseFloat(days) + (hours ? parseFloat(hours) / 24 : 0);
                }
            }
            return `${Math.floor(total)} days, ${Math.round((total % 1) * 24)} hours`;
        }
        
        function calculateTotalRations() {
            let total = 0;
            for (let i = 1; i <= stageCount; i++) {
                const rations = document.getElementById(`rations-${i}`);
                if (rations && rations.value) {
                    total += parseFloat(rations.value);
                }
            }
            return total.toFixed(1);
        }
        </script>
</body>
</html>
